<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem HPP & Operasi Pasar Gabah</title>
    <!-- Tailwind CSS untuk Styling Cepat & Responsif -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js untuk Grafik -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f0fdf4; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 20px; margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .input-group label { display: block; font-size: 0.875rem; font-weight: 600; color: #374151; margin-bottom: 5px; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 8px; outline: none; transition: border-color 0.3s; }
        .input-field:focus { border-color: #16a34a; ring: 2px solid #16a34a; }
        .subtitle { font-size: 0.9rem; color: #4b5563; margin-top: -5px; margin-bottom: 20px; }
        .bold { font-weight: 700; }
        .text-right { text-align: right; }
        
        /* Custom Alert Box */
        .alert-box { padding: 15px; border-radius: 8px; margin-top: 20px; display: none; align-items: center; gap: 10px; animation: fadeIn 0.5s; }
        .alert-danger { background-color: #fef2f2; border: 1px solid #ef4444; color: #991b1b; }
        .alert-warning { background-color: #fffbeb; border: 1px solid #f59e0b; color: #92400e; }
        .alert-success { background-color: #f0fdf4; border: 1px solid #22c55e; color: #166534; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="pb-10">

    <!-- HEADER -->
    <div class="bg-green-700 text-white p-6 text-center shadow-lg relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/ag-square.png')]"></div>
        <h1 class="text-2xl md:text-3xl font-bold relative z-10">üåæ Perhitungan HPP & Operasi Pasar</h1>
        <div class="subtitle text-green-100 mt-2 relative z-10">HPP dan Harga Gabah Kering Giling penetapan pemerintah</div>
    </div>

    <div class="max-w-6xl mx-auto px-4 mt-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <!-- KOLOM KIRI: INPUT DATA -->
        <div class="lg:col-span-5 space-y-4">
            
            <!-- 1. STATUS PANEN -->
            <div class="card border-l-4 border-green-500">
                <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center">üìä 1. Status Panen</h2>
                <div class="flex gap-4">
                    <label class="flex items-center cursor-pointer p-3 border rounded-lg w-1/2 hover:bg-green-50 transition">
                        <input type="radio" name="statusPanen" value="berhasil" class="w-5 h-5 text-green-600" checked onchange="togglePuso(false)">
                        <span class="ml-2 font-semibold text-green-700">‚úÖ Berhasil</span>
                    </label>
                    <label class="flex items-center cursor-pointer p-3 border rounded-lg w-1/2 hover:bg-red-50 transition">
                        <input type="radio" name="statusPanen" value="puso" class="w-5 h-5 text-red-600" onchange="togglePuso(true)">
                        <span class="ml-2 font-semibold text-red-700">‚ùå Puso (Gagal)</span>
                    </label>
                </div>
            </div>

            <!-- 2. RINCIAN BIAYA (Form) -->
            <div id="costSection" class="card">
                <h2 class="text-lg font-bold text-gray-800 mb-4">üí∞ 2. Rincian Biaya & Hasil</h2>
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group">
                        <label>Benih (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="500000">
                    </div>
                    <div class="input-group">
                        <label>Pupuk (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="1200000">
                    </div>
                    <div class="input-group">
                        <label>Pestisida (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="400000">
                    </div>
                    <div class="input-group">
                        <label>Tenaga Kerja (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="2500000">
                    </div>
                    <div class="input-group">
                        <label>Bahan Bakar (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="300000">
                    </div>
                    <div class="input-group">
                        <label>Sewa Lahan (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="1500000">
                    </div>
                    <div class="input-group col-span-2">
                        <label>Operasional Lainnya (Rp)</label>
                        <input type="number" class="input-field cost-input" placeholder="0" value="200000">
                    </div>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200 bg-gray-50 p-3 rounded-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-gray-600 font-semibold">Total Biaya Produksi:</span>
                        <span id="displayTotalCost" class="font-bold text-lg text-gray-800">Rp 0</span>
                    </div>
                    <div class="input-group mt-3">
                        <label class="text-blue-700">üåæ Total Hasil Panen (Kg GKG)</label>
                        <input type="number" id="inputHarvestResult" class="input-field border-blue-300 bg-blue-50 font-bold text-lg" placeholder="Contoh: 1000" value="1500">
                    </div>
                </div>
            </div>

            <!-- 7. TARGET & PASAR -->
            <div id="targetSection" class="card">
                <h2 class="text-lg font-bold text-gray-800 mb-4">üéØ 3. Target & Harga Pasar</h2>
                
                <div class="space-y-4">
                    <!-- Target Petani -->
                    <div class="p-3 bg-green-50 rounded-lg border border-green-200">
                        <label class="block text-sm font-bold text-green-800 mb-1">Target Keuntungan Petani (%)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="inputFarmerPercent" class="input-field w-24 text-center font-bold text-green-700" value="20" min="0">
                            <span class="text-gray-500 text-sm flex-1">Estimasi: <span id="farmerRupiahPreview" class="font-bold text-green-600">Rp 0</span> /kg</span>
                        </div>
                    </div>

                    <!-- Target Pemerintah -->
                    <div class="p-3 bg-blue-50 rounded-lg border border-blue-200 relative">
                        <label class="block text-sm font-bold text-blue-800 mb-1">Penetapan Harga Pemerintah (%)</label>
                        <div class="flex items-center gap-2">
                            <input type="number" id="inputGovPercent" class="input-field w-24 text-center font-bold text-blue-700" value="25">
                            <span class="text-gray-500 text-sm flex-1">Harus > Petani. <br>Estimasi: <span id="govRupiahPreview" class="font-bold text-blue-600">Rp 0</span> /kg</span>
                        </div>
                        <p id="govErrorMsg" class="text-xs text-red-500 mt-1 hidden italic">‚ö†Ô∏è Tidak boleh di bawah target petani!</p>
                    </div>

                    <!-- Simulasi Pasar -->
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-300">
                        <label class="block text-sm font-bold text-gray-800 mb-1">üîç Simulasi: Harga Beras Pedagang di Pasar</label>
                        <input type="number" id="inputTraderRicePrice" class="input-field text-lg font-bold text-gray-800" placeholder="Rp..." value="11000">
                        <p class="text-xs text-gray-500 mt-1">Masukkan harga jual beras di pasar saat ini untuk cek trigger Operasi Pasar.</p>
                    </div>
                </div>
            </div>

        </div>

        <!-- KOLOM KANAN: HASIL & VISUALISASI -->
        <div class="lg:col-span-7 space-y-6">

            <!-- Chart -->
            <div class="card relative h-80">
                <canvas id="priceChart"></canvas>
                <div id="chartOverlay" class="absolute inset-0 bg-white/80 flex items-center justify-center hidden backdrop-blur-sm z-10">
                    <span class="text-xl font-bold text-red-600 border-2 border-red-600 p-4 rounded-lg transform -rotate-12">PUSO / GAGAL PANEN</span>
                </div>
            </div>

            <!-- Hasil Perhitungan (Tabel) -->
            <div class="card overflow-hidden p-0">
                <div class="bg-gray-100 p-4 border-b">
                    <h3 class="font-bold text-gray-700">üìã Ringkasan Analisa Harga</h3>
                </div>
                <div class="p-4">
                    <table class="w-full text-sm md:text-base">
                        <tbody id="resultTableBody">
                            <!-- Diisi oleh Javascript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Info Konversi -->
                <div class="bg-blue-50 p-3 text-xs text-center text-blue-800 border-t border-blue-100">
                    ‚ÑπÔ∏è Konversi: 1.57 Kg Gabah Kering Giling (GKG) = 1 Kg Beras
                </div>
            </div>

            <!-- ALERT BOXES / TRIGGERS -->
            <div id="alertContainer">
                <!-- Alerts will be injected here -->
            </div>

        </div>
    </div>

    <script>
        // --- Utilities ---
        const formatRp = (num) => {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        };

        // --- State Management ---
        let isPuso = false;
        let chartInstance = null;

        // --- DOM Elements ---
        const inputs = document.querySelectorAll('.cost-input');
        const inputHarvest = document.getElementById('inputHarvestResult');
        const displayTotalCost = document.getElementById('displayTotalCost');
        const inputFarmerPercent = document.getElementById('inputFarmerPercent');
        const inputGovPercent = document.getElementById('inputGovPercent');
        const inputTraderRicePrice = document.getElementById('inputTraderRicePrice');
        const govErrorMsg = document.getElementById('govErrorMsg');
        const farmerPreview = document.getElementById('farmerRupiahPreview');
        const govPreview = document.getElementById('govRupiahPreview');
        const resultTableBody = document.getElementById('resultTableBody');
        const alertContainer = document.getElementById('alertContainer');
        const chartOverlay = document.getElementById('chartOverlay');

        // --- Logic: Puso Toggle ---
        function togglePuso(state) {
            isPuso = state;
            const sections = [document.getElementById('costSection'), document.getElementById('targetSection')];
            
            if (isPuso) {
                sections.forEach(el => el.style.opacity = '0.5');
                sections.forEach(el => el.style.pointerEvents = 'none');
                chartOverlay.classList.remove('hidden');
                calculateAll(); // Trigger calc to show alerts immediately
            } else {
                sections.forEach(el => el.style.opacity = '1');
                sections.forEach(el => el.style.pointerEvents = 'auto');
                chartOverlay.classList.add('hidden');
                calculateAll();
            }
        }

        // --- Logic: Calculations ---
        function calculateAll() {
            // 1. Calculate Total Cost
            let totalCost = 0;
            inputs.forEach(input => {
                totalCost += Number(input.value) || 0;
            });
            displayTotalCost.innerText = formatRp(totalCost);

            // 2. Get Harvest Result
            const harvestKg = Number(inputHarvest.value) || 0;

            // 3. Calculate HPP (Harga Pokok Produksi) per KG Gabah
            let hpp = 0;
            if (harvestKg > 0) {
                hpp = totalCost / harvestKg;
            }

            // 4. Handle Percentages Validation
            let farmerPct = Number(inputFarmerPercent.value);
            let govPct = Number(inputGovPercent.value);

            // Force Govt > Farmer rule
            if (govPct < farmerPct) {
                govErrorMsg.classList.remove('hidden');
                inputGovPercent.classList.add('border-red-500', 'bg-red-50');
                // Auto correct for calculation purposes, but keep UI warning
                // govPct = farmerPct; 
            } else {
                govErrorMsg.classList.add('hidden');
                inputGovPercent.classList.remove('border-red-500', 'bg-red-50');
            }

            // 5. Calculate Target Prices (GKG)
            const farmerPriceGKG = hpp + (hpp * (farmerPct / 100));
            const govPriceGKG = hpp + (hpp * (govPct / 100));

            // Previews in Input
            farmerPreview.innerText = formatRp(farmerPriceGKG);
            govPreview.innerText = formatRp(govPriceGKG);

            // 6. Conversions to Rice (1.57 factor)
            // Logic: Price of 1kg Rice corresponds to cost of 1.57kg Gabah
            const CONVERSION_FACTOR = 1.57;
            
            const hppRiceEq = hpp * CONVERSION_FACTOR; // Biaya modal setara beras
            const govPriceRiceEq = govPriceGKG * CONVERSION_FACTOR; // Harga wajar beras menurut pemerintah
            
            // 7. Get Trader Market Price (Input User)
            const traderRicePrice = Number(inputTraderRicePrice.value) || 0;

            // --- Generate Results ---
            renderTable(hpp, farmerPct, farmerPriceGKG, govPct, govPriceGKG, traderRicePrice, isPuso);
            renderAlerts(isPuso, hpp, traderRicePrice, govPriceRiceEq, farmerPriceGKG, govPriceGKG);
            updateChart(hpp, farmerPriceGKG, govPriceGKG, traderRicePrice / CONVERSION_FACTOR); 
            // Note: Chart compares GKG prices. So trader rice price is converted BACK to GKG equivalent for visual comparison
        }

        // --- Rendering Table ---
        function renderTable(hpp, farmerPct, farmerPrice, govPct, govPrice, traderPrice, puso) {
            if (puso) {
                resultTableBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-600 font-bold">Data tidak tersedia karena Gagal Panen (Puso)</td></tr>`;
                return;
            }

            // dbTani array structure based on user prompt requirements mapped to variables
            const dbTani = {
                6: hpp,
                13: farmerPct,
                8: farmerPrice,
                12: govPct,
                7: govPrice,
                9: traderPrice
            };

            resultTableBody.innerHTML = `
                <tr style="background-color: #e3f2fd; border-bottom: 1px solid #dee2e6;">
                    <td class="p-3"><strong>Biaya Produksi Per Kg (HPP)</strong> <br><span class="text-xs text-gray-500">Modal Gabah</span></td>
                    <td class="p-3 text-right bold text-gray-700">${formatRp(dbTani[6])}</td>
                </tr>
                <tr style="color: green; border-bottom: 1px solid #dee2e6;">
                    <td class="p-3">Target Petani (+<strong>${dbTani[13]}%</strong>) <br><span class="text-xs text-green-600">Harga Jual Gabah Petani</span></td>
                    <td class="p-3 text-right font-bold">${formatRp(dbTani[8])}</td>
                </tr>
                <tr style="color: blue; border-bottom: 1px solid #dee2e6;">
                    <td class="p-3">Standar Pemerintah (+<strong>${dbTani[12]}%</strong>) <br><span class="text-xs text-blue-600">Batas Atas Pembelian Gabah</span></td>
                    <td class="p-3 text-right bold">${formatRp(dbTani[7])}</td>
                </tr>
                <tr style="font-size: 1.1em; background-color: #fff7ed;">
                    <td class="p-3"><strong>Harga Jual Beras Pedagang</strong> <br><span class="text-xs text-orange-600">Harga Pasar (Beras)</span></td>
                    <td class="p-3 text-right bold text-orange-700">${formatRp(dbTani[9])}</td>
                </tr>
            `;
        }

        // --- Rendering Alerts / Triggers ---
        function renderAlerts(puso, hpp, traderRicePrice, govPriceRiceEq, farmerPriceGKG, govPriceGKG) {
            let html = '';

            // Trigger 1: PUSO
            if (puso) {
                html += `
                <div class="alert-box alert-danger" style="display:flex">
                    <span class="text-2xl">üö®</span>
                    <div>
                        <strong class="block text-lg">GAGAL PANEN (PUSO) DETEKSI!</strong>
                        <p>Produksi terhenti. Pemerintah <strong>WAJIB MELAKUKAN OPERASI PASAR</strong> untuk menjaga stok beras dan membantu petani melalui asuransi/bantuan.</p>
                    </div>
                </div>`;
            } 
            // Trigger 2: HPP Minus / Tidak Logis (Sangat Murah atau 0)
            else if (hpp <= 0) {
                 html += `
                <div class="alert-box alert-warning" style="display:flex">
                    <span class="text-2xl">‚ö†Ô∏è</span>
                    <div>
                        <strong>Data Biaya Produksi Tidak Valid</strong>
                        <p>Mohon isi rincian biaya dan hasil panen dengan benar.</p>
                    </div>
                </div>`;
            }
            else {
                // Trigger 3: Harga Pedagang Lebih Tinggi dari Standar Pemerintah
                // Logic: Jika Trader Price (Beras) > Govt Price (converted to Beras eq)
                if (traderRicePrice > govPriceRiceEq) {
                    const diff = traderRicePrice - govPriceRiceEq;
                    html += `
                    <div class="alert-box alert-danger" style="display:flex">
                        <span class="text-2xl">üì¢</span>
                        <div>
                            <strong class="block text-lg">PERINGATAN: HARGA PASAR TINGGI!</strong>
                            <p>Harga pedagang (${formatRp(traderRicePrice)}) melampaui standar kewajaran pemerintah (${formatRp(govPriceRiceEq)}).
                            <br><span class="bg-red-600 text-white px-2 py-1 rounded text-sm mt-1 inline-block font-bold">LAKUKAN OPERASI PASAR SEGERA!</span></p>
                        </div>
                    </div>`;
                } else {
                    html += `
                    <div class="alert-box alert-success" style="display:flex">
                        <span class="text-2xl">‚úÖ</span>
                        <div>
                            <strong>Pasar Stabil</strong>
                            <p>Harga pedagang masih dalam batas kewajaran standar pemerintah. Tidak perlu operasi pasar.</p>
                        </div>
                    </div>`;
                }

                // Sub-Trigger: Buying Below Production Cost (Simulation)
                // Jika User memasukkan harga pedagang yang jika dikonversi ke gabah, lebih rendah dari HPP
                const impliedGKGPrice = traderRicePrice / 1.57; // Hitung mundur
                if (impliedGKGPrice < hpp && traderRicePrice > 0) {
                     html += `
                    <div class="alert-box alert-warning" style="display:flex">
                        <span class="text-2xl">üìâ</span>
                        <div>
                            <strong>Potensi Kerugian Petani</strong>
                            <p>Harga pasar saat ini mengindikasikan pembelian gabah di bawah Biaya Produksi (HPP). Pemerintah disarankan menyerap gabah petani (Bulog).</p>
                        </div>
                    </div>`;
                }
            }

            alertContainer.innerHTML = html;
        }

        // --- Chart JS Logic ---
        function updateChart(hpp, farmerPrice, govPrice, traderPriceGKGEquivalent) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            const dataValues = isPuso ? [0, 0, 0, 0] : [hpp, farmerPrice, govPrice, traderPriceGKGEquivalent];

            if (chartInstance) {
                chartInstance.data.datasets[0].data = dataValues;
                chartInstance.update();
            } else {
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['HPP (Modal)', 'Target Petani', 'Standar Pemerintah', 'Estimasi Beli Pedagang'],
                        datasets: [{
                            label: 'Harga per Kg (Basis Gabah)',
                            data: dataValues,
                            backgroundColor: [
                                'rgba(107, 114, 128, 0.6)', // Grey
                                'rgba(34, 197, 94, 0.7)',   // Green (Petani)
                                'rgba(59, 130, 246, 0.7)',  // Blue (Govt)
                                'rgba(249, 115, 22, 0.7)'   // Orange (Pedagang)
                            ],
                            borderColor: [
                                'rgba(107, 114, 128, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(59, 130, 246, 1)',
                                'rgba(249, 115, 22, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return formatRp(context.raw);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) { return formatRp(value); }
                                }
                            }
                        }
                    }
                });
            }
        }

        // --- Event Listeners ---
        inputs.forEach(input => input.addEventListener('input', calculateAll));
        inputHarvest.addEventListener('input', calculateAll);
        inputFarmerPercent.addEventListener('input', calculateAll);
        inputGovPercent.addEventListener('input', calculateAll);
        inputTraderRicePrice.addEventListener('input', calculateAll);

        // Init
        calculateAll();

    </script>
</body>
</html>